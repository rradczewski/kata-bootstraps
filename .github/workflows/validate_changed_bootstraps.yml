name: Validate changed Bootstraps

on: [push, pull_request]

jobs:
  find_bootstraps:
    name: Find changed bootstraps
    runs-on: ubuntu-latest
    outputs:
      bootstraps: ${{ steps.generate-matrix.outputs.bootstraps }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Run changed-files with json output
        id: changed-dirs
        uses: tj-actions/changed-files@v38
        with:
          dir_names: true
      - name: Generate Matrix
        id: generate-matrix
        run: |
          set -x
          BOOTSTRAPS=$(ls -d */ | sed 's/.$//');

          CHANGED_FILES=$(echo "${{ steps.changed-dirs.outputs.all_changed_files }}" | xargs -n1)

          CHANGED_BOOTSTRAPS=$(for bootstrap in $BOOTSTRAPS;
          do
            echo "$CHANGED_FILES" | grep -qE "^${bootstrap}" && echo "$bootstrap" || true
          done | jq -Rsc '. / "\n" - [""]')
          echo ::set-output name=bootstraps::${CHANGED_BOOTSTRAPS}

  run_tests:
    name: Validate Bootstrap ${{ matrix.bootstrap }}
    needs: [find_bootstraps]
    runs-on: ubuntu-latest
    if: ${{ needs.find_bootstraps.outputs.bootstraps != '[]' && needs.find_bootstraps.outputs.bootstraps != '' }}
    strategy:
      matrix:
        bootstrap: ${{ fromJson(needs.find_bootstraps.outputs.bootstraps) }}
    steps:
      - uses: actions/setup-node@v3
        with:
          node-version: lts/*
      - uses: actions/checkout@v3
      - name: Install Dev Tools
        working-directory: .bin/
        run: npm install
      - name: Set up container for ${{ matrix.bootstrap }}
        run: |
          ./.bin/start_devcontainer.sh "${{ matrix.bootstrap }}"
      - name: Expect failing test for ${{ matrix.bootstrap }}
        run: |
          ./.bin/run_test_in_devcontainer.sh "${{ matrix.bootstrap }}"
